supported_targets:
  - raspberrypi4
  - raspberrypi5


distro:
  version: 0.1.0
  channel: apollo-edge

runtimes:
  dev:
    stone_include_paths:
      - stone/{{ avocado.target }}
    packages:
      avocado-runtime: '{{ avocado.distro.version }}'
    extensions:
      - rubicon
      - config-dev
      - avocado-ext-cockpit
      - avocado-ext-docker
      - avocado-ext-dev
      - avocado-ext-sshd-dev
      - avocado-ext-cli
      - avocado-bsp-{{ avocado.target }}

extensions:
  avocado-ext-cockpit:
    source:
      type: package
      version: '*'

  avocado-ext-docker:
    source:
      type: package
      version: '*'

  avocado-ext-dev:
    source:
      type: package
      version: '*'

  avocado-ext-sshd-dev:
    source:
      type: package
      version: '*'

  avocado-bsp-{{ avocado.target }}:
    source:
      type: package
      version: '*'

  avocado-ext-cli:
    source:
      type: package
      version: '*'

  rubicon:
    version: 0.1.0
    overlay: overlay

    modprobe:
      - brcmfmac

    enable_services:
      - rubicon-usb-gadget.service
      - rubicon-usb-network.service
      - rubicon-ca-certificates.service
      - serial-getty@ttyGS0.service
      - dnsmasq.service
      - avahi-daemon.service
      - wpa_supplicant@wlan0.service

    on_merge:
      - systemctl restart --no-block rubicon-usb-gadget.service
      - systemctl restart --no-block rubicon-usb-network.service
      - systemctl restart --no-block rubicon-ca-certificates.service
      - systemctl restart --no-block serial-getty@ttyGS0.service
      - systemctl restart --no-block dnsmasq.service
      - systemctl restart --no-block avahi-daemon.service
      - systemctl restart --no-block wpa_supplicant@wlan0.service
      - systemctl restart --no-block docker.service
      - networkctl reload

    on_unmerge:
      - systemctl stop --no-block wpa_supplicant@wlan0.service
      - systemctl stop --no-block avahi-daemon.service
      - systemctl stop --no-block dnsmasq.service
      - systemctl stop --no-block serial-getty@ttyGS0.service

    packages:
      dnsmasq: '*'
      avahi-daemon: '*'
      kernel-module-dwc2: '*'
      kernel-module-libcomposite: '*'
      kernel-module-usb-f-acm: '*'
      kernel-module-usb-f-ecm: '*'
      qemu-user-static: '*'
      qemu-user-static-binfmt: '*'

  config-dev:
    version: 0.1.0

    users:
      root:
        password: ''

sdk:
  image: docker.io/avocadolinux/sdk:{{ avocado.distro.channel }}
  container_args:
    - --privileged
    - --network=host
    - -v /dev:/dev
    - -v /sys:/sys
    - --add-host=rubicon.local:10.55.0.1

  packages:
    avocado-sdk-toolchain: '{{ avocado.distro.version }}'
